<!DOCTYPE html>  <html> <head>   <title>settings.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="server.html">                 server.js               </a>                                           <a class="source" href="settings.html">                 settings.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               settings.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Settings</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Express</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">port</span>     <span class="o">=</span> <span class="mi">3000</span>
  <span class="p">,</span> <span class="nx">cacheAge</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Common</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">fs</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">colors</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">mime</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mime&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">gzippo</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gzippo&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>Good and bad</h1>

<p><strong>TODO:</strong> this should be added to Marak's <code>colors</code>
 (e.g. 'mystring'.bad -- which would prepend the red ✗)</p>

<p>Don't use error/success since that <em>could</em> conflict with callbacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">good</span> <span class="o">=</span> <span class="s2">&quot;  ✔ &quot;</span><span class="p">.</span><span class="nx">green</span>
  <span class="p">,</span> <span class="nx">bad</span> <span class="o">=</span> <span class="s2">&quot;  ✗ &quot;</span><span class="p">.</span><span class="nx">red</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Config</h2>

<p>Based on your project's needs, you should configure <code>package.json</code>
  accordingly to the <a href="http://npmjs.org">npm</a> packages used.
  <a href="http://wiki.commonjs.org/wiki/Packages/1.0">http://wiki.commonjs.org/wiki/Packages/1.0</a></p>

<p>, config = require('./config')</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Mongo Session Store</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">MongoStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect-mongo&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>Cross Site Request Forgery</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">csrf</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express-csrf&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>Stylesheets</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">stylus</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stylus&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">nib</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nib&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Logs</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">logs</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">set</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">string</span><span class="o">:</span> <span class="s1">&#39;\\n  &#39;</span> <span class="o">+</span> <span class="s1">&#39;:date&#39;</span><span class="p">.</span><span class="nx">bold</span><span class="p">.</span><span class="nx">underline</span> <span class="o">+</span> <span class="s1">&#39;\\n\\n&#39;</span> <span class="o">+</span> <span class="s1">&#39;  IP: &#39;</span><span class="p">.</span><span class="nx">cyan</span><span class="p">.</span><span class="nx">bold</span>
        <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;:remote-addr&#39;</span><span class="p">.</span><span class="nx">white</span> <span class="o">+</span> <span class="s1">&#39;\\n&#39;</span> <span class="o">+</span> <span class="s1">&#39;  Method: &#39;</span><span class="p">.</span><span class="nx">red</span><span class="p">.</span><span class="nx">bold</span>
        <span class="o">+</span> <span class="s1">&#39;:method&#39;</span><span class="p">.</span><span class="nx">white</span> <span class="o">+</span> <span class="s1">&#39;\\n&#39;</span> <span class="o">+</span> <span class="s1">&#39;  URL: &#39;</span><span class="p">.</span><span class="nx">blue</span><span class="p">.</span><span class="nx">bold</span> <span class="o">+</span> <span class="s1">&#39;:url&#39;</span><span class="p">.</span><span class="nx">white</span>
        <span class="o">+</span> <span class="s1">&#39;\\n&#39;</span> <span class="o">+</span> <span class="s1">&#39;  Status: &#39;</span><span class="p">.</span><span class="nx">yellow</span><span class="p">.</span><span class="nx">bold</span> <span class="o">+</span> <span class="s1">&#39;:status&#39;</span><span class="p">.</span><span class="nx">white</span> <span class="o">+</span> <span class="s1">&#39;\\n&#39;</span>
        <span class="o">+</span> <span class="s1">&#39;  User Agent: &#39;</span><span class="p">.</span><span class="nx">magenta</span><span class="p">.</span><span class="nx">bold</span> <span class="o">+</span> <span class="s1">&#39;:user-agent&#39;</span><span class="p">.</span><span class="nx">white</span>
    <span class="p">}</span>
  <span class="p">,</span> <span class="nx">css</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">debug</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">set</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">string</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
          <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">good</span> <span class="o">+</span> <span class="s1">&#39; Stylus has detected changes and compiled new assets&#39;</span>
          <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="s1">&#39; times so far&#39;</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Set cache busting for development purposes as a view middleware helper</h2>

<p>This gets turned off in production mode, see below</p>

<p>(e.g. <code>views/layout.jade</code> uses this for appending .css/.js w/?v=timestamp)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">cacheBusting</span> <span class="o">=</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Stylus Compiler</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span> <span class="nx">compress</span> <span class="o">=</span> <span class="kc">false</span> <span class="c1">// this is set to true in prod</span>
  <span class="p">,</span> <span class="nx">linenos</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// this is set to false in prod</span>
  <span class="p">,</span> <span class="nx">compiler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">css</span><span class="p">.</span><span class="nx">set</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">css</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">cssString</span> <span class="o">=</span> <span class="nx">css</span><span class="p">.</span><span class="nx">string</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cssString</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">stylus</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;compress&#39;</span><span class="p">,</span> <span class="nx">compress</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;firebug&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="nx">linenos</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">nib</span><span class="p">());</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Helper functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><a href="http://dailyjs.com/2010/12/06/node-tutorial-5/">Return existing connection info</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">mongoStoreConnectionArgs</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="nx">db</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">db</span><span class="p">.</span><span class="nx">databaseName</span>
    <span class="p">,</span> <span class="nx">host</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">db</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">host</span>
    <span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">db</span><span class="p">.</span><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">port</span>
    <span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">user</span>
    <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="nx">db</span><span class="p">.</span><span class="nx">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pass</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Logout middleware helper</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Login middleware helper</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">loggedIn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">loggedIn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">loggedIn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Create a "super_admin" user and group if one does not already exist</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">createSuperAdmin</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Groups</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./schemas/groups&#39;</span><span class="p">)(</span><span class="nx">db</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./schemas/users&#39;</span><span class="p">)(</span><span class="nx">db</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">superGroup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;super_admin&quot;</span>
      <span class="p">}</span>
    <span class="p">,</span> <span class="nx">superUser</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">email</span><span class="o">:</span> <span class="s2">&quot;admin@expressling.com&quot;</span>
        <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">first</span><span class="o">:</span> <span class="s2">&quot;SuperAdmin&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="o">:</span> <span class="s2">&quot;McLovin&quot;</span> <span class="p">}</span>
        <span class="p">,</span> <span class="nx">company</span><span class="o">:</span> <span class="s2">&quot;Brogrammers LLC.&quot;</span>
        <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;admin&quot;</span>
        <span class="p">,</span> <span class="nx">_group</span><span class="o">:</span> <span class="nx">superGroup</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">};</span>
  <span class="nx">Groups</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">superGroup</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Groups</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">superGroup</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Users</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">superUser</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bad</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">good</span> <span class="o">+</span> <span class="s2">&quot;&#39;super_admin&#39; user/group created&quot;</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Create a "user" user and group if one does not already exist</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">createUser</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Groups</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./schemas/groups&#39;</span><span class="p">)(</span><span class="nx">db</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./schemas/users&#39;</span><span class="p">)(</span><span class="nx">db</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">userGroup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;user&quot;</span>
      <span class="p">}</span>
    <span class="p">,</span> <span class="nx">defaultUser</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">email</span><span class="o">:</span> <span class="s2">&quot;user@expressling.com&quot;</span>
        <span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">first</span><span class="o">:</span> <span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="o">:</span> <span class="s2">&quot;McLovin&quot;</span> <span class="p">}</span>
        <span class="p">,</span> <span class="nx">company</span><span class="o">:</span> <span class="s2">&quot;Users Rock Inc.&quot;</span>
        <span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;user&quot;</span>
        <span class="p">,</span> <span class="nx">_group</span><span class="o">:</span> <span class="nx">userGroup</span><span class="p">.</span><span class="nx">_id</span>
      <span class="p">};</span>
  <span class="nx">Groups</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">userGroup</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Groups</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">userGroup</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">group</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Users</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">defaultUser</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bad</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">good</span> <span class="o">+</span> <span class="s2">&quot;&#39;user&#39; user/group created&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">group</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>Application Configuration</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">bootApplication</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>Create Super Admin</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">createSuperAdmin</span><span class="p">(</span><span class="nx">db</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Create User Group</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">createUser</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">db</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Default Settings</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Views</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/views&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;jade&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Load Mongo session store</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span>
        <span class="nx">secret</span><span class="o">:</span> <span class="s2">&quot;##### CHANGE THIS SECRET TO SOMETHING PRIVATE AND HASHED #####&quot;</span>
      <span class="p">,</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">cacheAge</span>
      <span class="p">,</span> <span class="nx">store</span><span class="o">:</span> <span class="k">new</span> <span class="nx">MongoStore</span><span class="p">(</span><span class="nx">mongoStoreConnectionArgs</span><span class="p">(</span><span class="nx">db</span><span class="p">))</span>
    <span class="p">}));</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Check for csrf using express-csrf module</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">csrf</span><span class="p">.</span><span class="nx">check</span><span class="p">());</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Favicon</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">favicon</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public/favicon.ico&#39;</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Extra Route Middleware</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logout</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">loggedIn</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Routing (keep this last)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>Development Settings</h3>

<pre><code>For a quick start
$ node server.js
Or if you have installed nodemon via:
$ npm install -g nodemon
$ nodemon
Then point your browser to &lt;http://localhost:8080/&gt;.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">stylus</span><span class="p">.</span><span class="nx">middleware</span><span class="p">({</span>
      <span class="nx">src</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/views&#39;</span><span class="p">,</span>
      <span class="nx">dest</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">,</span>
      <span class="nx">debug</span><span class="o">:</span> <span class="nx">css</span><span class="p">.</span><span class="nx">debug</span><span class="p">,</span>
      <span class="nx">compile</span><span class="o">:</span> <span class="nx">compiler</span>
    <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">cacheAge</span> <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;showStackError&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">logs</span><span class="p">.</span><span class="nx">set</span><span class="p">)</span> <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="nx">logs</span><span class="p">.</span><span class="nx">string</span><span class="p">));</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h3>Staging Settings</h3>

<p><strong>TODO</strong>: Build out the configuration for this mode.
<code>$ NODE_ENV=staging node server.js</code>
Then point your browser to <a href="http://localhost:8081/">http://localhost:8081/</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>Production Settings</h3>

<p><code>$ NODE_ENV=production node server.js</code>
Then point your browser to <a href="http://localhost/">http://localhost/</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">cacheBusting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">compress</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">linenos</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">stylus</span><span class="p">.</span><span class="nx">middleware</span><span class="p">({</span>
      <span class="nx">src</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/views&#39;</span><span class="p">,</span>
      <span class="nx">dest</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">,</span>
      <span class="nx">debug</span><span class="o">:</span> <span class="nx">css</span><span class="p">.</span><span class="nx">debug</span><span class="p">,</span>
      <span class="nx">compile</span><span class="o">:</span> <span class="nx">compiler</span>
    <span class="p">}));</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Enable gzip compression is for production mode only</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">gzippo</span><span class="p">.</span><span class="nx">staticGzip</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">cacheAge</span> <span class="p">}));</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Disable stack error output</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;showStackError&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Enable view caching</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="s1">&#39;view cache&#39;</span><span class="p">);</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h3>Dynamic View Helpers</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">dynamicHelpers</span><span class="p">({</span>
    <span class="nx">request</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">req</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">base</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Return the app's mount-point so that urls can adjust</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="s1">&#39;/&#39;</span> <span class="o">===</span> <span class="nx">app</span><span class="p">.</span><span class="nx">route</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">route</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><a href="https://github.com/visionmedia/express-messages/">Flash messages</a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">messages</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express-messages&#39;</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><a href="https://github.com/loopj/commonjs-date-formatting/">Dateformat helper</a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">dateformat</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/dateformat&#39;</span><span class="p">).</span><span class="nx">strftime</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">loggedIn</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">cacheBusting</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">cacheBusting</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">user</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">access</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">groupName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loggedIn</span>
          <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">groupName</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span>
          <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span>
          <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_group</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">groupName</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">groupName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_group</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">groupName</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_group</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">groupName</span> <span class="o">===</span> <span class="s2">&quot;super_admin&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Generate token using
 <a href="https://github.com/hanssonlarsson/express-csrf/">express-csrf</a>
 and in your Jade view use the following:
 <code>input(type="hidden",name="csrf", value=csrf)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">csrf</span><span class="o">:</span> <span class="nx">csrf</span><span class="p">.</span><span class="nx">token</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h2>Error Configuration</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">bootErrorConfig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Since this is the last non-error-handling middleware use()d,
 we assume 404, as nothing else responded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>The status option, or res.statusCode = 404 are equivalent,
 however with the option we get the "status" local available as well</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;404&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">layout</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">status</span><span class="o">:</span> <span class="mi">404</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Page not found :(&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <pre><code>Error-handling middleware, take the same form as regular middleware,
however they require an arity of 4, aka the signature (err, req, res, next)
when connect has an error, it will invoke ONLY error-handling middleware.

If we were to next() here any remaining non-error-handling middleware would
then be executed, or if we next(err) to continue passing the error, only
error-handling middleware would remain being executed, however here we
simply respond with an error page.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>We may use properties of the error object here and next(err)
appropriately, or if we possibly recovered from the error, simply next().</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;500&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">layout</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">status</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">,</span>
      <span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">,</span>
      <span class="nx">showStack</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">showStackError</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Something went wrong, oops!&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h2>Load Routes</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">bootRoutes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">walk</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;walk&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">path</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">files</span>   <span class="o">=</span> <span class="p">[]</span>
    <span class="p">,</span> <span class="nx">dir</span>     <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;routes&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">walker</span>  <span class="o">=</span> <span class="nx">walk</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="p">{</span> <span class="nx">followLinks</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>

  <span class="nx">walker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">stat</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">root</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">walker</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">require</span><span class="p">(</span><span class="nx">file</span><span class="p">)(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">db</span><span class="p">);</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Always keep this route last</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">exports</span><span class="p">.</span><span class="nx">bootExtras</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h2>Extras</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">bootExtras</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span>
      <span class="p">,</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;user-agent&#39;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>Block access to hidden files and directories that begin with a period</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(^|\/)\./</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;Not allowed&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h3>Better website experience for IE users</h3>

<p>Force the latest IE version, in cases when it may fall back to IE7 mode</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="nx">ua</span> <span class="o">&amp;&amp;</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;MSIE&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="sr">/htm?l/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ua</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;X-UA-Compatible&#39;</span><span class="p">,</span> <span class="s1">&#39;IE=Edge,chrome=1&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h3>CORS</h3>

<p><a href="http://github.com/rails/rails/commit/123eb25#commitcomment-118920">http://github.com/rails/rails/commit/123eb25#commitcomment-118920</a>
 Use ChromeFrame if it's installed, for a better experience with IE folks
 Control cross domain using CORS http://enable-cors.org</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">,</span> <span class="s2">&quot;X-Requested-With&quot;</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 